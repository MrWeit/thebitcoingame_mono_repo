# Penetration Testing Checklist

**Service:** TheBitcoinGame CKPool Mining Service
**Last Updated:** 2026-02-23
**Owner:** Security / Infrastructure Team
**Review Cadence:** Before each production stage transition

---

## Overview

This checklist covers security testing for the CKPool mining service across four domains: stratum protocol, network infrastructure, container security, and Bitcoin-specific attack vectors. Each item should be tested and documented with findings.

**Severity Ratings:**
- CRITICAL: Exploitable vulnerability with direct financial or data impact
- HIGH: Exploitable vulnerability with operational or indirect financial impact
- MEDIUM: Weakness that requires specific conditions to exploit
- LOW: Informational finding, defense-in-depth improvement

---

## 1. Stratum Protocol Security

The stratum port (TCP 3333) is the primary attack surface. CKPool's C-based JSON parser must handle arbitrary input without memory corruption.

### Buffer Overflow / Memory Corruption
- [ ] **STR-001**: Send JSON strings exceeding internal buffer sizes (test 1KB, 4KB, 16KB, 64KB, 256KB, 1MB)
  - Target: `mining.subscribe` params, `mining.authorize` username/password
  - Expected: Connection dropped, no crash
  - Severity if failed: CRITICAL

- [ ] **STR-002**: Send extremely long JSON keys (> 256 chars)
  - Expected: Ignored or connection dropped
  - Severity if failed: HIGH

- [ ] **STR-003**: Fuzz JSON parser with AFL/libFuzzer on CKPool binary directly
  - Generate corpus from valid stratum messages
  - Run for minimum 24 hours
  - Severity if crash found: CRITICAL

### Integer Overflow
- [ ] **STR-004**: Submit share with difficulty value at INT64_MAX, INT32_MAX, 0, -1, NaN
  - Target: `mining.submit` nonce, ntime fields
  - Expected: Share rejected, no crash
  - Severity if failed: CRITICAL

- [ ] **STR-005**: Set `mining.subscribe` ID to extreme values (MAX_INT, negative, float, string)
  - Expected: Handled gracefully
  - Severity if failed: MEDIUM

- [ ] **STR-006**: Send job_id with overflow values in `mining.submit`
  - Expected: Share rejected
  - Severity if failed: HIGH

### Memory Exhaustion
- [ ] **STR-007**: Open maximum connections and hold them idle (slowloris variant)
  - Test 100, 500, 1000, 5000 concurrent idle connections
  - Monitor CKPool memory and file descriptor usage
  - Expected: Rate limiting or connection timeout kicks in
  - Severity if failed: HIGH

- [ ] **STR-008**: Send subscribe but never authorize â€” hold connection for hours
  - Monitor memory growth per idle unauthorized connection
  - Expected: Timeout and disconnect after configured period
  - Severity if failed: MEDIUM

- [ ] **STR-009**: Rapid connect/disconnect cycles (10,000 connections in 60 seconds)
  - Monitor for memory leaks from connection churn
  - Expected: Stable memory after connections close
  - Severity if failed: HIGH

### Slowloris / Slow Read Attack
- [ ] **STR-010**: Send stratum data one byte at a time with 1-second delays
  - Hold connection for > 10 minutes with minimal data
  - Expected: Timeout and disconnect
  - Severity if failed: MEDIUM

- [ ] **STR-011**: Subscribe and read responses one byte at a time (slow read)
  - Expected: Write timeout or buffer limit reached
  - Severity if failed: MEDIUM

### Invalid Encoding
- [ ] **STR-012**: Send ISO-8859-1, UTF-16, UTF-32 encoded JSON
  - Expected: Rejected, connection dropped
  - Severity if failed: LOW

- [ ] **STR-013**: Send JSON with BOM (byte order mark) prefix
  - Expected: Handled or rejected gracefully
  - Severity if failed: LOW

- [ ] **STR-014**: Embed null bytes at various positions in JSON payloads
  - Expected: Truncated or rejected, no crash
  - Severity if failed: HIGH

---

## 2. Network Security

### Port Scanning
- [ ] **NET-001**: Full TCP port scan of all containers
  - Verify only expected ports are open:
    - CKPool: 3333 (stratum), 9100 (metrics)
    - Bitcoin: 38332 (RPC)
    - Redis: 6379
    - TimescaleDB: 5432
    - Prometheus: 9090
    - Grafana: 3030
  - Severity if unexpected port: MEDIUM

- [ ] **NET-002**: UDP port scan of all containers
  - Expected: No unexpected UDP services
  - Severity if unexpected: MEDIUM

### Service Exposure
- [ ] **NET-003**: Verify Bitcoin RPC is not accessible from outside Docker network
  - Test: `curl http://<host>:38332/` from external network
  - Expected: Connection refused or no route
  - Severity if exposed: CRITICAL

- [ ] **NET-004**: Verify Redis is not accessible from outside Docker network
  - Test: `redis-cli -h <host> -p 6379 ping` from external network
  - Expected: Connection refused
  - Severity if exposed: CRITICAL

- [ ] **NET-005**: Verify TimescaleDB is not accessible externally
  - Expected: Connection refused from external
  - Severity if exposed: CRITICAL

- [ ] **NET-006**: Verify Prometheus and Grafana have authentication
  - Grafana: default admin password must be changed
  - Prometheus: should not be publicly accessible without auth
  - Severity if unauthenticated: HIGH

### TLS Configuration
- [ ] **NET-007**: If TLS termination is configured for stratum:
  - Verify TLS 1.2+ only (no SSLv3, TLS 1.0, TLS 1.1)
  - Check cipher suite strength (no RC4, DES, export ciphers)
  - Verify certificate validity and chain
  - Severity if weak: HIGH

### DNS Rebinding
- [ ] **NET-008**: Attempt DNS rebinding to access internal services
  - Use a domain that resolves to 127.0.0.1 after initial external resolution
  - Expected: No internal service access via rebinding
  - Severity if successful: HIGH

---

## 3. Infrastructure / Container Security

### Docker Escape
- [ ] **INF-001**: Check if containers run as root
  ```bash
  docker exec tbg-ckpool whoami
  docker exec tbg-redis whoami
  docker exec tbg-timescaledb whoami
  ```
  - Expected: Non-root user for all services
  - Severity if root: MEDIUM

- [ ] **INF-002**: Check for privileged containers
  ```bash
  docker inspect --format='{{.HostConfig.Privileged}}' tbg-ckpool
  ```
  - Expected: false for all containers
  - Severity if privileged: CRITICAL

- [ ] **INF-003**: Check for dangerous capabilities
  ```bash
  docker inspect --format='{{.HostConfig.CapAdd}}' tbg-ckpool
  ```
  - Expected: No SYS_ADMIN, NET_ADMIN (except for tc netem in test)
  - Severity if dangerous caps: HIGH

- [ ] **INF-004**: Check for host mounts
  ```bash
  docker inspect --format='{{range .Mounts}}{{.Source}} -> {{.Destination}} ({{.Mode}}){{"\n"}}{{end}}' tbg-ckpool
  ```
  - Expected: Only config (:ro), logs, and run directories
  - Severity if sensitive host paths: HIGH

### Privilege Escalation
- [ ] **INF-005**: Check for setuid binaries inside containers
  ```bash
  docker exec tbg-ckpool find / -perm -4000 -type f 2>/dev/null
  ```
  - Expected: Minimal setuid binaries
  - Severity if exploitable: HIGH

- [ ] **INF-006**: Check container user namespace mapping
  - Verify userns-remap is enabled in Docker daemon (if supported)
  - Severity if not: LOW

### Secret Exposure
- [ ] **INF-007**: Check environment variables for secrets
  ```bash
  docker inspect --format='{{range .Config.Env}}{{println .}}{{end}}' tbg-ckpool
  docker inspect --format='{{range .Config.Env}}{{println .}}{{end}}' tbg-event-collector
  ```
  - Expected: No plaintext passwords in env (use Docker secrets)
  - Known issue: Current dev setup uses env vars (acceptable for signet/testnet)
  - Severity if in production: HIGH

- [ ] **INF-008**: Check Docker image layers for embedded secrets
  ```bash
  docker history tbg-ckpool --no-trunc
  ```
  - Expected: No secrets baked into image layers
  - Severity if found: HIGH

- [ ] **INF-009**: Check if `.env` files are committed to git
  - Expected: .env in .gitignore
  - Severity if committed: HIGH

### Log Injection
- [ ] **INF-010**: Send stratum messages with log-format strings
  - Include `%s`, `%n`, `%x` in worker names and params
  - Include newlines and ANSI escape codes
  - Expected: Logged literally, no format string exploitation
  - Severity if format string vuln: CRITICAL

- [ ] **INF-011**: Send stratum messages designed to inject false log entries
  - Include `\n[INFO] Block found!` in worker name
  - Expected: Proper escaping in log output
  - Severity if injectable: MEDIUM

---

## 4. Bitcoin-Specific Attack Vectors

### Block Withholding
- [ ] **BTC-001**: Simulate a block withholding attack
  - Submit valid shares but withhold shares that meet the block target
  - Verify detection mechanisms (if implemented):
    - Statistical analysis of share submission patterns
    - Ratio of valid shares to expected block solutions
  - Expected: Detection or documentation of known limitation
  - Severity: MEDIUM (affects pool economics)

### Share Difficulty Manipulation
- [ ] **BTC-002**: Submit shares that claim higher difficulty than actual
  - Modify the share submission to overreport difficulty
  - Expected: Pool independently validates share difficulty
  - Severity if not validated: CRITICAL

- [ ] **BTC-003**: Attempt to bypass VarDiff by rapid reconnection
  - Connect, get low initial difficulty, submit share, disconnect, repeat
  - Expected: Reconnect memory (enhanced VarDiff) assigns previous difficulty
  - Severity if bypassed: HIGH

- [ ] **BTC-004**: Submit duplicate shares (same nonce/ntime)
  - Expected: Duplicate detection rejects second submission
  - Severity if accepted: MEDIUM

### Address Spoofing
- [ ] **BTC-005**: Authorize with another user's Bitcoin address
  - Expected: All users mine to their own address (address = username in CKPool)
  - Verify no cross-contamination of share attribution
  - Severity if spoofable: CRITICAL

- [ ] **BTC-006**: Authorize with invalid Bitcoin addresses
  - Test: empty string, non-base58/bech32, wrong network (mainnet addr on testnet)
  - Expected: Rejected with appropriate error
  - Severity if accepted: MEDIUM

### Coinbase Transaction Tampering
- [ ] **BTC-007**: Verify coinbase transaction includes correct pool address
  - Extract coinbase from block template, decode, verify output address
  - Expected: Output pays to configured pool address
  - Severity if wrong: CRITICAL

- [ ] **BTC-008**: Verify per-user coinbase signature is sanitized
  - Attempt to inject invalid opcodes or oversized data via coinbase sig
  - Expected: Signature is sanitized/truncated to safe length
  - Severity if injectable: HIGH

- [ ] **BTC-009**: Verify coinbase transaction is valid for network rules
  - Check: correct version, valid witness commitment, correct block height in scriptsig
  - Expected: Valid transaction per consensus rules
  - Severity if invalid: CRITICAL

### Stratum Protocol Abuse
- [ ] **BTC-010**: Submit work for a previous (stale) job
  - Expected: Stale share rejection
  - Severity if accepted: LOW

- [ ] **BTC-011**: Submit work with manipulated version bits (AsicBoost detection)
  - Test overt ASICBoost (version rolling)
  - Verify pool correctly handles or detects version rolling
  - Expected: Tracked and emitted as event
  - Severity: Informational

---

## Test Execution Log

| Test ID | Date | Tester | Result | Severity | Notes |
|---------|------|--------|--------|----------|-------|
| | | | | | |
| | | | | | |

## Findings Summary

| Severity | Count | Fixed | Outstanding |
|----------|-------|-------|-------------|
| CRITICAL | | | |
| HIGH | | | |
| MEDIUM | | | |
| LOW | | | |

---

## Tools Reference

- **nmap**: Port scanning (`nmap -sT -sU -p- <host>`)
- **AFL/libFuzzer**: Fuzz testing CKPool JSON parser
- **python3**: Custom stratum protocol scripts
- **Chaos test suite**: `services/tests/chaos/` (covers many STR tests)
- **docker-bench-security**: Docker CIS benchmark (`docker run --net host --pid host docker/docker-bench-security`)
- **trivy**: Container image vulnerability scanning (`trivy image tbg-ckpool`)
- **testssl.sh**: TLS configuration testing
