services:
  # Bitcoin Core regtest node (local test network — real block finding)
  bitcoin-regtest:
    image: lncm/bitcoind:v27.0
    container_name: tbg-bitcoin-regtest
    command:
      - -regtest
      - -server=1
      - -rpcuser=tbg
      - -rpcpassword=tbgdev2026
      - -rpcallowip=0.0.0.0/0
      - -rpcbind=0.0.0.0
      - -rpcport=18443
      - -zmqpubhashblock=tcp://0.0.0.0:28332
      - -zmqpubrawtx=tcp://0.0.0.0:28333
      - -txindex=1
      - -fallbackfee=0.00001
      - -dbcache=256
    ports:
      - "18443:18443"   # Regtest RPC
      - "28332:28332"   # ZMQ hashblock
    volumes:
      - bitcoin-regtest-data:/home/bitcoin/.bitcoin
    healthcheck:
      test: ["CMD", "bitcoin-cli", "-regtest", "-rpcuser=tbg", "-rpcpassword=tbgdev2026", "-rpcport=18443", "getblockchaininfo"]
      interval: 10s
      timeout: 5s
      retries: 60
      start_period: 30s
    restart: unless-stopped

  # Regtest bootstrap (creates wallet + mines 101 maturity blocks, then exits)
  regtest-init:
    image: lncm/bitcoind:v27.0
    container_name: tbg-regtest-init
    depends_on:
      bitcoin-regtest:
        condition: service_healthy
    volumes:
      - ./scripts/regtest-init.sh:/regtest-init.sh:ro
    entrypoint: ["/bin/sh", "/regtest-init.sh"]
    restart: "no"

  # CKPool mining engine (GPLv3 fork with TBG patches)
  ckpool:
    build:
      context: ./ckpool
      dockerfile: Dockerfile
    container_name: tbg-ckpool
    depends_on:
      bitcoin-regtest:
        condition: service_healthy
      regtest-init:
        condition: service_completed_successfully
    ports:
      - "3333:3333"     # Stratum port
      - "9100:9100"     # Prometheus metrics
    volumes:
      - ckpool-logs:/var/log/ckpool
      - ckpool-run:/var/run/ckpool
      - ckpool-events:/tmp/ckpool
      - ./ckpool/config:/etc/ckpool:ro
    entrypoint: ["/bin/sh", "-c"]
    command: ["rm -f /var/run/ckpool/main.pid && exec /opt/ckpool/bin/ckpool -c /etc/ckpool/ckpool-regtest.conf -s /var/run/ckpool -l 7"]
    restart: unless-stopped

  # Redis (event streams + pub/sub)
  redis:
    image: redis:7-alpine
    container_name: tbg-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    restart: unless-stopped

  # TimescaleDB (PostgreSQL + time-series extensions)
  timescaledb:
    image: timescale/timescaledb:latest-pg16
    container_name: tbg-timescaledb
    environment:
      POSTGRES_USER: tbg
      POSTGRES_PASSWORD: tbgdev2026
      POSTGRES_DB: thebitcoingame
    ports:
      - "5432:5432"
    volumes:
      - timescaledb-data:/var/lib/postgresql/data
      - ./event-collector/sql/init.sql:/docker-entrypoint-initdb.d/01-init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U tbg -d thebitcoingame"]
      interval: 5s
      timeout: 3s
      retries: 10
    restart: unless-stopped

  # Event Collector (Python — reads from ckpool Unix socket, publishes to Redis + DB)
  event-collector:
    build:
      context: ./event-collector
      dockerfile: Dockerfile
    container_name: tbg-event-collector
    depends_on:
      redis:
        condition: service_healthy
      timescaledb:
        condition: service_healthy
    volumes:
      - ckpool-events:/tmp/ckpool
    environment:
      REDIS_URL: redis://redis:6379/0
      DATABASE_URL: postgresql://tbg:tbgdev2026@timescaledb:5432/thebitcoingame
      SOCKET_PATH: /tmp/ckpool/events.sock
      LOG_LEVEL: DEBUG
      BATCH_FLUSH_INTERVAL: "1.0"
      BATCH_MAX_SIZE: "500"
      REDIS_STREAM_MAXLEN: "100000"
    restart: unless-stopped

  # Prometheus (metrics collection)
  prometheus:
    image: prom/prometheus:latest
    container_name: tbg-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.retention.time=30d
    restart: unless-stopped

  # Grafana (metrics dashboards)
  grafana:
    image: grafana/grafana:latest
    container_name: tbg-grafana
    ports:
      - "3030:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: tbgdev2026
      GF_USERS_ALLOW_SIGN_UP: "false"
    restart: unless-stopped

  # Backend API (FastAPI)
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: tbg-api
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "8000:8000"
    environment:
      TBG_DATABASE_URL: postgresql+asyncpg://tbg:tbgdev2026@timescaledb:5432/thebitcoingame
      TBG_REDIS_URL: redis://redis:6379/0
      TBG_DEBUG: "true"
      TBG_ENVIRONMENT: development
      TBG_LOG_LEVEL: DEBUG
      TBG_CORS_ORIGINS: '["http://localhost:5173","http://localhost:3000"]'
      TBG_JWT_PRIVATE_KEY_PATH: /app/keys/jwt_private.pem
      TBG_JWT_PUBLIC_KEY_PATH: /app/keys/jwt_public.pem
      TBG_BTC_NETWORK: regtest
      TBG_FRONTEND_BASE_URL: http://localhost:5173
      TBG_EMAIL_PROVIDER: smtp
      TBG_SMTP_HOST: localhost
      TBG_SMTP_PORT: "1025"
      TBG_RATE_LIMIT_REQUESTS: "1000"
      TBG_RATE_LIMIT_WINDOW_SECONDS: "60"
    volumes:
      - ./api/src:/app/src:ro
      - ./api/keys:/app/keys:ro
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; r = httpx.get('http://localhost:8000/health'); r.raise_for_status()"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # Event Consumer (arq worker — reads mining events from Redis Streams)
  event-consumer:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: tbg-event-consumer
    command: ["python", "-m", "tbg.workers.event_consumer_runner"]
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      TBG_DATABASE_URL: postgresql+asyncpg://tbg:tbgdev2026@timescaledb:5432/thebitcoingame
      TBG_REDIS_URL: redis://redis:6379/0
      TBG_CONSUMER_NAME: api-worker-1
      TBG_WORKER_TIMEOUT_SECONDS: "600"
    restart: unless-stopped

  # Gamification Worker (badges, XP, streaks — reads mining events from Redis Streams)
  gamification-worker:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: tbg-gamification-worker
    command: ["python", "-m", "tbg.workers.gamification_runner"]
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      TBG_DATABASE_URL: postgresql+asyncpg://tbg:tbgdev2026@timescaledb:5432/thebitcoingame
      TBG_REDIS_URL: redis://redis:6379/0
      TBG_GAMIFICATION_CONSUMER: gam-worker-1
    restart: unless-stopped

  # CPU Miner (for testing — mines on ckpool stratum)
  cpuminer:
    build:
      context: ./cpuminer
      dockerfile: Dockerfile
    container_name: tbg-cpuminer
    depends_on:
      - ckpool
    command:
      - --url=stratum+tcp://ckpool:3333
      - --user=mfnNyPsinywVCqCr35215gviGo8cWGiDnb.worker1
      - --pass=x
      - --threads=1
      - --algo=sha256d
      - --retry-pause=5
      - --debug
    restart: unless-stopped

volumes:
  bitcoin-regtest-data:
  ckpool-logs:
  ckpool-run:
  ckpool-events:
  redis-data:
  timescaledb-data:
  prometheus-data:
  grafana-data:
