# TheBitcoinGame — Linux Kernel Tuning for 100k+ Concurrent Connections
# Apply with: sysctl -p /path/to/sysctl.conf
#
# Target: CKPool Stratum server handling 100,000+ miner connections
# Host requirements: 16GB+ RAM, 4+ CPU cores
#
# WARNING: These settings are aggressive and tuned for a dedicated mining pool
# server. Do NOT apply on shared/general-purpose systems without review.

# =============================================================================
# TCP/IP Stack — Connection Handling
# =============================================================================

# Maximum number of connections that can be queued for acceptance
net.core.somaxconn = 65535

# Maximum number of packets queued on the INPUT side when the interface
# receives packets faster than the kernel can process them
net.core.netdev_max_backlog = 65536

# Maximum SYN backlog — pending connections waiting for ACK
net.ipv4.tcp_max_syn_backlog = 65536

# TIME_WAIT bucket table size (increase for many connections)
net.ipv4.tcp_max_tw_buckets = 2000000

# Allow reuse of TIME_WAIT sockets for new connections
net.ipv4.tcp_tw_reuse = 1

# Increase the port range for outbound connections
net.ipv4.ip_local_port_range = 1024 65535

# =============================================================================
# TCP/IP Stack — Buffer Sizes
# =============================================================================

# Default and max socket receive/send buffer sizes
# Stratum messages are small, but we need many buffers
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_default = 262144
net.core.wmem_max = 16777216

# TCP auto-tuning buffer sizes: min, default, max
net.ipv4.tcp_rmem = 4096 262144 16777216
net.ipv4.tcp_wmem = 4096 262144 16777216

# Total TCP memory (pages): min, pressure, max
# With 16GB RAM: allow TCP to use up to ~4GB
net.ipv4.tcp_mem = 786432 1048576 1572864

# =============================================================================
# TCP/IP Stack — Keepalive & Timeouts
# =============================================================================

# Send keepalive probes after 60s of idle (detect dead miners fast)
net.ipv4.tcp_keepalive_time = 60

# Send keepalive probes every 10 seconds once started
net.ipv4.tcp_keepalive_intvl = 10

# Drop connection after 6 failed keepalive probes (60s detection)
net.ipv4.tcp_keepalive_probes = 6

# FIN_WAIT2 timeout — release sockets from dead connections faster
net.ipv4.tcp_fin_timeout = 15

# =============================================================================
# TCP/IP Stack — SYN Flood Protection
# =============================================================================

# Enable SYN cookies (protection against SYN flood attacks)
net.ipv4.tcp_syncookies = 1

# Maximum number of remembered connection requests without ACK
net.ipv4.tcp_max_orphans = 262144

# =============================================================================
# File Descriptors
# =============================================================================

# System-wide maximum number of file descriptors
# Each TCP connection = 1 fd; 100k miners + overhead = 131072
fs.file-max = 262144

# Maximum number of file handles the kernel will allocate
fs.nr_open = 262144

# =============================================================================
# Memory Management
# =============================================================================

# Overcommit strategy: 0 = heuristic, 1 = always, 2 = never
# Use heuristic — allows fork() for ckpool child processes
vm.overcommit_memory = 0

# Swappiness: minimize swapping for latency-sensitive workload
vm.swappiness = 10

# Minimum free memory (KB) before reclaiming — prevent OOM in bursts
vm.min_free_kbytes = 131072

# Dirty page writeback thresholds (optimize for many small writes)
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5

# =============================================================================
# Conntrack (if using iptables/nftables firewall)
# =============================================================================

# Maximum tracked connections — must exceed maxclients
net.netfilter.nf_conntrack_max = 262144

# Reduce conntrack timeout for established TCP (default 432000 = 5 days)
# Mining connections are persistent; 3600s is enough for cleanup
net.netfilter.nf_conntrack_tcp_timeout_established = 3600

# =============================================================================
# ARP Cache (for large networks)
# =============================================================================

net.ipv4.neigh.default.gc_thresh1 = 4096
net.ipv4.neigh.default.gc_thresh2 = 8192
net.ipv4.neigh.default.gc_thresh3 = 16384
